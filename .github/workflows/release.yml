name: Auto Release

on:
  push:
    tags:
      - 'v*' # Trigger on tags starting with v (e.g. v1.2.0)

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install pyinstaller instaloader Pillow

      - name: Download tools (yt-dlp & ffmpeg)
        run: |
          mkdir bin
          Invoke-WebRequest -Uri "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe" -OutFile "bin/yt-dlp.exe"
          Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg_temp"
          $ffmpegPath = Get-ChildItem -Path "ffmpeg_temp" -Recurse -Filter "ffmpeg.exe" | Select-Object -First 1
          Move-Item -Path $ffmpegPath.FullName -Destination "bin/"

      - name: Build EXE
        run: |
          pyinstaller --name "yt_downloader" --onefile --windowed --add-data "bin;bin" src/main.py

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/yt_downloader.exe

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install pyinstaller instaloader Pillow

      - name: Download tools
        run: |
          mkdir -p bin
          curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp_macos -o bin/yt-dlp
          chmod +x bin/yt-dlp
          curl -L https://evermeet.cx/ffmpeg/getrelease/zip -o ffmpeg.zip
          unzip -o -q ffmpeg.zip -d bin
          chmod +x bin/ffmpeg

      - name: Build PKG
        run: |
          PIL_PATH=$(python -c "import PIL; import os; print(os.path.dirname(PIL.__file__))")
          python -m PyInstaller --name "YouTubeDownloader" --onefile --windowed --add-data "bin:bin" --add-data "$PIL_PATH:PIL" --paths "$PIL_PATH" --hidden-import=PIL --hidden-import=PIL._tkinter_finder --hidden-import=PIL.Image --hidden-import=PIL.ImageTk src/main.py
          pkgbuild --install-location /Applications --component "dist/YouTubeDownloader.app" "dist/YouTubeDownloader.pkg"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-pkg
          path: dist/YouTubeDownloader.pkg

  release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-exe

      - name: Download macOS Artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-pkg

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            yt_downloader.exe
            YouTubeDownloader.pkg
          draft: false
          prerelease: false
          generate_release_notes: true
